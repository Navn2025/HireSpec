version: "3.8"

services:
  # MySQL Database
  mysql:
    image: mysql:8.0
    container_name: interview_platform_db
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD:-rootpassword}
      MYSQL_DATABASE: ${DB_NAME:-interview_platform_db}
      MYSQL_USER: ${DB_USER:-dbuser}
      MYSQL_PASSWORD: ${DB_PASSWORD:-dbpassword}
    ports:
      - "${DB_PORT:-3306}:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./database/unified-schema.sql:/docker-entrypoint-initdb.d/schema.sql
    networks:
      - platform_network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 20s
      retries: 10

  # Node.js Backend (Interviews, Coding Practice, AI Features)
  nodejs_backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: nodejs_backend
    restart: always
    environment:
      PORT: 5000
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:5173}
      DB_HOST: mysql
      DB_PORT: 3306
      DB_USER: ${DB_USER:-dbuser}
      DB_PASSWORD: ${DB_PASSWORD:-dbpassword}
      DB_NAME: ${DB_NAME:-interview_platform_db}
      GROQ_API_KEY: ${GROQ_API_KEY}
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      PINECONE_API_KEY: ${PINECONE_API_KEY}
      PINECONE_INDEX: ${PINECONE_INDEX}
    ports:
      - "5000:5000"
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - platform_network
    volumes:
      - ./backend:/app
      - /app/node_modules

  # Python Backend (Authentication, Face Recognition, Hiring)
  python_backend:
    build:
      context: ./Hiring-and-Assesment-Portal/backend
      dockerfile: Dockerfile
    container_name: python_backend
    restart: always
    environment:
      FLASK_ENV: production
      DB_HOST: mysql
      DB_PORT: 3306
      DB_USER: ${DB_USER:-dbuser}
      DB_PASSWORD: ${DB_PASSWORD:-dbpassword}
      DB_NAME: ${DB_NAME:-interview_platform_db}
      FRONTEND_ORIGIN: ${FRONTEND_URL:-http://localhost:5173}
      SECRET_KEY: ${SECRET_KEY:-change-me-in-production}
      MAIL_SERVER: ${MAIL_SERVER}
      MAIL_PORT: ${MAIL_PORT}
      MAIL_USERNAME: ${MAIL_USERNAME}
      MAIL_PASSWORD: ${MAIL_PASSWORD}
    ports:
      - "5001:5001"
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - platform_network
    volumes:
      - ./Hiring-and-Assesment-Portal/backend:/app
      - ./Hiring-and-Assesment-Portal/backend/uploads:/app/uploads

  # Frontend (React + Vite)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: frontend
    restart: always
    ports:
      - "${FRONTEND_PORT:-5173}:5173"
    environment:
      VITE_NODEJS_API_URL: http://nodejs_backend:5000
      VITE_PYTHON_API_URL: http://python_backend:5001
    depends_on:
      - nodejs_backend
      - python_backend
    networks:
      - platform_network
    volumes:
      - ./frontend:/app
      - /app/node_modules

  # Nginx API Gateway (Optional - for production)
  nginx:
    image: nginx:alpine
    container_name: api_gateway
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - nodejs_backend
      - python_backend
      - frontend
    networks:
      - platform_network
    profiles:
      - production

networks:
  platform_network:
    driver: bridge

volumes:
  mysql_data:
    driver: local
